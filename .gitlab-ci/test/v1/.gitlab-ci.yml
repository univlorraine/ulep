stages:
  - packages

# Base des CI
.base:
  stage: packages
  trigger:
    include: .gitlab-ci/template-ci.yml
    strategy: depend

# CI de l'admin
ðŸ§© admin:
  extends: .base
  variables:
    WORKING_DIR: admin
    IMAGE_NAME: ulep/admin
    DOCKERFILE_PATH: .gitlab-ci/Dockerfile.admin
  rules:
    - changes: # la CI n'est dÃ©clenchÃ©e que lorsqu'il y a une modification dans le path prÃ©cisÃ©
        - admin/**/*

# CI de l'initialisation API
ðŸ§© api init:
  extends: .base
  variables:
    WORKING_DIR: api
    IMAGE_NAME: ulep/api-init
    DOCKER_TARGET: api_init
  rules:
    - changes:
        - api/libs/common/src/database/**/*

# CI de l'API
ðŸ§© api:
  extends: .base
  variables:
    WORKING_DIR: api
    IMAGE_NAME: ulep/api
    DOCKERFILE_PATH: .gitlab-ci/Dockerfile.api
    DOCKER_TARGET: api_ul
  rules:
    - changes:
        - api/**/*

# CI de l'API (mode dev)
ðŸ§© api dev:
  extends: ðŸ§© api
  variables:
    NODE_ENV_CI: development
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'

# CI du thÃ¨me UL Keycloak
ðŸ§© auth ul theme:
  extends: .base
  variables:
    WORKING_DIR: docker/keycloak
    IMAGE_NAME: ulep/auth-ul-theme
    TAG: "1.0"
  rules:
    - changes:
        - docker/keycloak/**/*

# CI de la webapp
ðŸ§© webapp:
  extends: .base
  variables:
    WORKING_DIR: app
    IMAGE_NAME: ulep/webapp
  rules:
    - changes:
        - app/**/*
