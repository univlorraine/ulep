# Template CI qui inclut les dÃ©pendances, lint et test dans les jobs api et admin

variables:
  NODE_VERSION: 18
  DOCKERFILE_PATH: $WORKING_DIR/Dockerfile

stages:
  - ðŸ“¦ build

.dependencies: # Build des dÃ©pendances
  stage: ðŸ“¦ build
  image: node:$NODE_VERSION-alpine
  before_script: # Installation des dÃ©pendances (cache pas forcÃ©ment utile : https://pnpm.io/fr/continuous-integration)
    # Pour pouvoir utiliser pnpm
    - corepack enable
    - corepack prepare --activate pnpm@latest
    - cd $WORKING_DIR
    - pnpm fetch # https://pnpm.io/fr/cli/fetch
    # --fix-lockfile pour "ERR_PNPM_OUTDATED_LOCKFILEâ€‰ Cannot install with "frozen-lockfile" because pnpm-lock.yaml is not up to date with package.json"
    # --prefer-offline pour "ERR_PNPM_NO_OFFLINE_META Failed to resolve webpack@>=5.0.0 <6.0.0-0 in package mirror /root/.cache/pnpm/metadata/registry.npmjs.org/webpack.json"
    # --frozen-lockfile pour CI (https://pnpm.io/fr/cli/install#--frozen-lockfile)
    - pnpm install --fix-lockfile --prefer-offline --frozen-lockfile
    # - pnpm i --no-frozen-lockfile

ðŸ–¥ï¸ admin: # Build de l'application d'admin
  extends: .dependencies
  script:
    - pnpm run lint
    - pnpm run build
    # - pnpm install --prod # Supprime les dÃ©pendances de dev (https://pnpm.io/fr/cli/prune). GÃ©nÃ¨re une erreur dans le pod "sh: react-scripts: not found"
  artifacts:
    paths:
      - $CI_PROJECT_DIR/$WORKING_DIR
      # A utiliser Ã  la place de la ligne prÃ©cÃ©dente si les sources ne sont plus nÃ©cessaires dans le fichier de dÃ©ploiement Helm
      # - $CI_PROJECT_DIR/$WORKING_DIR/build
      # - $CI_PROJECT_DIR/$WORKING_DIR/node_modules
    expire_in: 1 hour
  rules:
    - if: '($CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" ||  $CI_COMMIT_BRANCH == "ci") && $WORKING_DIR == "admin"' # TODO : ci Ã  supprimer

âš™ï¸ api: # Build de l'api
  extends: .dependencies
  script:
    - pnpm run lint
    # - pnpm run test # En erreur
    - pnpm prisma generate
    - pnpm run build
    # - pnpm install --prod (gÃ©nÃ¨re une erreur dans le pod mÃªme en mode prod : Error: Cannot find module '@faker-js/faker')
  artifacts:
    paths:
      - $CI_PROJECT_DIR/$WORKING_DIR/dist
      - $CI_PROJECT_DIR/$WORKING_DIR/node_modules
      - $CI_PROJECT_DIR/$WORKING_DIR/package.json
    expire_in: 1 hour
  rules:
    - if: '($CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" ||  $CI_COMMIT_BRANCH == "ci") 
            && $WORKING_DIR == "api" && $DOCKER_TARGET != "api_init"' # TODO : ci Ã  supprimer

ðŸš€ container image: # Build de l'image
  stage: ðŸ“¦ build
  needs:
    - job: ðŸ–¥ï¸ admin
      optional: true
    - job: âš™ï¸ api
      optional: true
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script: # Informations de connexion au registry Harbor dans un fichier de conf Kaniko
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "$CI_REGISTRY_USER" "$CI_REGISTRY_PASSWORD" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  script:
    # Ajout du NODE_ENV comme build-arg s'il est dÃ©fini
    - >
      if [ $NODE_ENV_CI ]; then
        NODE_ENV_CI_BUILD_ARGS="--build-arg NODE_ENV_CI=$NODE_ENV_CI"
      fi
    # Ajout des options de target si elle est dÃ©finie
    - >
      if [ $DOCKER_TARGET ]; then
        TARGET_OPTIONS="--target $DOCKER_TARGET --skip-unused-stages=true"
      fi  
    # Tag de l'image selon la version de l'app (cf package.json) si elle n'est pas fournie
    - >
      if [ -z $TAG]; then
        TAG=$(cat $CI_PROJECT_DIR/$WORKING_DIR/package.json | grep version | head -1 | awk -F= "{ print $2 }" | sed 's/[version:,\",]//g' | tr -d '[[:space:]]')
      fi
    # Suffixe avec le nom de la branche si la branche n'est pas main
    - >
      if [ $CI_COMMIT_BRANCH != "main" ]; then
        TAG=$TAG-$CI_COMMIT_BRANCH
      fi
    # Build de l'image docker et push sur harbor
    - /kaniko/executor
      --context $CI_PROJECT_DIR/$WORKING_DIR
      --build-arg NODE_VERSION=$NODE_VERSION $NODE_ENV_CI_BUILD_ARGS
      --dockerfile $CI_PROJECT_DIR/$DOCKERFILE_PATH
      $TARGET_OPTIONS
      --destination $CI_REGISTRY_IMAGE/$IMAGE_NAME:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" ||  $CI_COMMIT_BRANCH == "ci"' # TODO : ci Ã  supprimer
