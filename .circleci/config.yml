#
#   Copyright ou © ou Copr. Université de Lorraine, (2025)
#
#   Direction du Numérique de l'Université de Lorraine - SIED
#
#   Ce logiciel est un programme informatique servant à rendre accessible
#   sur mobile et sur internet l'application ULEP (University Language
#   Exchange Programme) aux étudiants et aux personnels des universités
#   parties prenantes.
#
#   Ce logiciel est régi par la licence CeCILL 2.1, soumise au droit français
#   et respectant les principes de diffusion des logiciels libres. Vous pouvez
#   utiliser, modifier et/ou redistribuer ce programme sous les conditions
#   de la licence CeCILL telle que diffusée par le CEA, le CNRS et INRIA
#   sur le site "http://cecill.info".
#
#   En contrepartie de l'accessibilité au code source et des droits de copie,
#   de modification et de redistribution accordés par cette licence, il n'est
#   offert aux utilisateurs qu'une garantie limitée. Pour les mêmes raisons,
#   seule une responsabilité restreinte pèse sur l'auteur du programme, le
#   titulaire des droits patrimoniaux et les concédants successifs.
#
#   À cet égard, l'attention de l'utilisateur est attirée sur les risques
#   associés au chargement, à l'utilisation, à la modification et/ou au
#   développement et à la reproduction du logiciel par l'utilisateur étant
#   donné sa spécificité de logiciel libre, qui peut le rendre complexe à
#   manipuler et qui le réserve donc à des développeurs et des professionnels
#   avertis possédant des connaissances informatiques approfondies. Les
#   utilisateurs sont donc invités à charger et à tester l'adéquation du
#   logiciel à leurs besoins dans des conditions permettant d'assurer la
#   sécurité de leurs systèmes et/ou de leurs données et, plus généralement,
#   à l'utiliser et à l'exploiter dans les mêmes conditions de sécurité.
#
#   Le fait que vous puissiez accéder à cet en-tête signifie que vous avez
#   pris connaissance de la licence CeCILL 2.1, et que vous en avez accepté les
#   termes.
#

version: 2.1

orbs:
  node: circleci/node@5.2.0
  docker: circleci/docker@2.6.0

executors:
  node-executor:
    docker:
      - image: cimg/node:20.9.0
      - image: cimg/postgres:14.0
        environment:
          POSTGRES_USER: postgres

commands:
  pnpm-install-api:
    steps:
      - run:
          name: Install pnpm package manager
          command: |
            cd api && npm i pnpm@10.7.0

jobs:
  ##### Code Quality #####
  # sonar-check:
  #   docker:
  #     - image: cimg/node:18.16.1
  #   working_directory: ~/api
  #   steps:
  #     - checkout
  #     - run:
  #         name: Install Sonar Runner
  #         command: |
  #           export SONAR_SCANNER_VERSION=5.0.1.3006
  #           export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
  #           curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
  #           unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
  #           export PATH=$SONAR_SCANNER_HOME/bin:$PATH
  #           export SONAR_SCANNER_OPTS="-server"
  #           sonar-scanner \
  #             -Dsonar.projectKey=thetribeio_etandem_AY2OFcz_UJJxCOVDfrTu \
  #             -Dsonar.sources=.  \
  #             -Dsonar.host.url=https://ecocode.thetribe.dev
  ##### API #####
  install-api:
    executor: node-executor
    working_directory: ~/api
    steps:
      - checkout
      - pnpm-install-api
  lint-api:
    executor: node-executor
    working_directory: ~/api
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            cd api && pnpm install --no-frozen-lockfile
      - run:
          name: Lint code
          command: cd api && pnpm lint
  test-api:
    executor: node-executor
    working_directory: ~/api
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: cd api && pnpm install --no-frozen-lockfile
      - run:
          name: Run tests
          command: cd api && pnpm run test
  build-docker-api:
    executor: node-executor
    working_directory: ~/api
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Install Dependencies
          command: |
            cd api && pnpm i --no-frozen-lockfile
      - run:
          name: Run build image
          command: |
            export DOCKER_BUILDKIT=1
            cd api && docker build --platform=linux/amd64 --target=api_prod -t rg.fr-par.scw.cloud/ulep/api-prod:latest -t rg.fr-par.scw.cloud/ulep/api-prod:1.0.<< pipeline.number >> .
            docker build --platform=linux/amd64 --target=api_init -t rg.fr-par.scw.cloud/ulep/api-init:latest -t rg.fr-par.scw.cloud/ulep/api-init:1.0.<< pipeline.number >> .
      - run:
          name: push docker image
          command: |
            echo "$DOCKER_PASS" | docker login rg.fr-par.scw.cloud/ulep -u nologin --password-stdin
            docker push rg.fr-par.scw.cloud/ulep/api-prod:latest && docker push rg.fr-par.scw.cloud/ulep/api-prod:1.0.<< pipeline.number >>
            docker push rg.fr-par.scw.cloud/ulep/api-init:latest && docker push rg.fr-par.scw.cloud/ulep/api-init:1.0.<< pipeline.number >>
  ##### ADMIN #####
  lint-admin:
    executor: node-executor
    working_directory: ~/api
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            cd admin && pnpm i --no-frozen-lockfile
      - run:
          name: Lint code
          command: cd admin && pnpm run lint
  tsc-build-admin:
    executor: node-executor
    working_directory: ~/api
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: cd admin && pnpm i --no-frozen-lockfile
      - run:
          name: Run build
          command: cd admin && pnpm run build
  build-docker-admin:
    executor: node-executor
    working_directory: ~/api
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Install Dependencies
          command: |
            cd admin && pnpm i --no-frozen-lockfile
      - run:
          name: Run build image
          command: |
            export DOCKER_BUILDKIT=1
            cd admin && docker build --platform=linux/amd64 --target=admin_prod -t rg.fr-par.scw.cloud/ulep/admin-prod:latest -t rg.fr-par.scw.cloud/ulep/admin-prod:1.0.<< pipeline.number >> .
      - run:
          name: push docker image
          command: |
            echo "$DOCKER_PASS" | docker login rg.fr-par.scw.cloud/ulep -u nologin --password-stdin
            docker push rg.fr-par.scw.cloud/ulep/admin-prod:latest && docker push rg.fr-par.scw.cloud/ulep/admin-prod:1.0.<< pipeline.number >>

  build-docker-webapp:
    executor: node-executor
    working_directory: ~/api
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Run build image
          command: |
            cd app && docker build --platform=linux/amd64 -t rg.fr-par.scw.cloud/ulep/webapp:latest -t rg.fr-par.scw.cloud/ulep/webapp:1.0.<< pipeline.number >> .
      - run:
          name: push docker image
          command: |
            echo "$DOCKER_PASS" | docker login rg.fr-par.scw.cloud/ulep -u nologin --password-stdin
            docker push rg.fr-par.scw.cloud/ulep/webapp:latest && docker push rg.fr-par.scw.cloud/ulep/webapp:1.0.<< pipeline.number >>

  #### AUTH ####
  build-docker-auth:
    executor: node-executor
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Build docker image
          command: |
            export DOCKER_BUILDKIT=1
            cd docker/keycloak && docker build --platform=linux/amd64 -t rg.fr-par.scw.cloud/ulep/auth-prod:latest -t rg.fr-par.scw.cloud/ulep/auth-prod:1.0.<< pipeline.number >> .
      - run:
          name: Push docker image
          command: |
            echo "$DOCKER_PASS" | docker login rg.fr-par.scw.cloud/ulep -u nologin --password-stdin
            docker push rg.fr-par.scw.cloud/ulep/auth-prod:latest && docker push rg.fr-par.scw.cloud/ulep/auth-prod:1.0.<< pipeline.number >>

  #### Chat ####
  build-docker-chat:
    executor: node-executor
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Build docker image
          command: |
            export DOCKER_BUILDKIT=1
            cd chat && docker build --platform=linux/amd64 -t rg.fr-par.scw.cloud/ulep/chat-prod:latest -t rg.fr-par.scw.cloud/ulep/chat-prod:1.0.<< pipeline.number >> .
      - run:
          name: Push docker image
          command: |
            echo "$DOCKER_PASS" | docker login rg.fr-par.scw.cloud/ulep -u nologin --password-stdin
            docker push rg.fr-par.scw.cloud/ulep/chat-prod:latest && docker push rg.fr-par.scw.cloud/ulep/chat-prod:1.0.<< pipeline.number >>

workflows:
  version: 2
  check_api:
    jobs:
      - install-api
      #- sonar-check
      - lint-api:
          requires:
            - install-api
      - test-api:
          requires:
            - lint-api
      - build-docker-api:
          requires:
            - lint-api
            - test-api
          filters:
            branches:
              only:
                - develop
                - main

  check_admin:
    jobs:
      - lint-admin
      - tsc-build-admin
      - build-docker-admin:
          requires:
            - tsc-build-admin
            - lint-admin
          filters:
            branches:
              only:
                - develop
                - main

  build_webapp:
    jobs:
      - build-docker-webapp:
          filters:
            branches:
              only:
                - develop
                - main

  build_auth:
    jobs:
      - build-docker-auth:
          filters:
            branches:
              only:
                - develop
                - main

  build_chat:
    jobs:
      - build-docker-chat:
          filters:
            branches:
              only:
                - develop
                - main
