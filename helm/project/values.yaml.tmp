# Default values for etandem.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# CLUSTER
name: 'ulep'
domain: &domain ulep.thestaging.io
issuerName: letsencrypt
ingressName: &ingressName traefik

# API
apiUrl: &apiUrl api
firebaseProjectId: &firebaseProjectId ulep-notifications
firebasePrivateKey: &firebasePrivateKey 'changeme'
firebaseClientEmail: &firebaseClientEmail changeme

# AUTH
authUrl: &authUrl auth

# JITSI
jitsiUrl: &jitsiUrl jitsi

# ADMIN
adminUrl: &adminUrl admin

# CHAT
chatUrl: &chatUrl chat
socketChatUrl: &socketChatUrl chat-ws

# MINIO
minioApiUrl: &minioApiUrl minio-api
minioUrl: &minioUrl minio
minioAccessKey: &minioAccessKey minio
minioSecretKey: &minioSecretKey AZE123aze

# KEYCLOAK
keycloakUrl: &keycloakUrl auth
keycloakAdminPassword: &keycloakAdminPassword AZE123aze
keycloakClientSecret: &keycloakClientSecret bN49BuApmmtAODeOWOG8iKOOuJdN3KE6

# WEBAPP
webappUrl: &webappUrl webapp

#WEBLATE
weblateApiUrl: &weblateApiUrl weblate

#GLITCHTIP
glitchtipUrl: &glitchtipUrl glitchtip

api:
  name: *apiUrl
  replicaCount: 1
  image:
    repository: rg.fr-par.scw.cloud/ulep/api-prod
    tag: '1.0.3110'
    pullPolicy: IfNotPresent
  initImage:
    repository: rg.fr-par.scw.cloud/ulep/api-init
    tag: '1.0.3110'
    pullPolicy: IfNotPresent
  env:
    adminUrl: *adminUrl
    chatUrl: *chatUrl
    appUrl: *webappUrl
    logLevel: debug
    defaultTranslationLanguage: en
    keycloakRealm: etandem
    keycloakAdmin: admin
    keycloakClientId: api
    keycloakClientSecret: *keycloakClientSecret
    keycloakAdminRoleName: admin
    minioUrl: https://minio-api.ulep.thestaging.io
    minioAccessKey: *minioAccessKey
    minioSecretKey: *minioSecretKey
    i18nReloadInterval: '3600000'
    i18nMinioUrl: https://minio-api.ulep.thestaging.io/i18n
    i18nDebug: true
    emailsAssetsBucket: assets
    notificationAssetsBucket: assets
    emailsTranslationsComponent: emails
    emailsAssetsPublicEndpoint: *minioUrl
    notificationAssetsPublicEndpoint: *minioUrl
    appLinkAppleStore: https://www.apple.com/fr/app-store/etandem
    appLinkPlayStore: https://play.google.com/store/apps/etandem
    smtpDisableBootVerification: false
    smtpHost: mailcatcher
    smtpPort: 1025
    smtpSecure: false
    smtpIgnoreTLS: true
    smtpSender: contact@ulep.fr
    firebaseProjectId: *firebaseProjectId
    firebasePrivateKey: *firebasePrivateKey
    firebaseClientEmail: *firebaseClientEmail
    firebaseParallelLimit: 3
    sentryDsn: https://70f6871957074455870c9f1d0ab2ed24@glitchtip.ulep.thestaging.io/4
    cancelTresholdInMin: 15
    signedUrlExpirationInSeconds: 3600
    weblateApiUrl: *weblateApiUrl
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
    # targetMemoryUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  probes:
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 6
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 5
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    hosts:
      - host: *apiUrl
        paths: [/]
    tls:
      - hosts:
          - *apiUrl

auth:
  name: *authUrl
  replicaCount: 1
  image:
    repository: 'quay.io/keycloak/keycloak'
    tag: '21.1'
    pullPolicy: IfNotPresent
  initImage:
    repository: 'rg.fr-par.scw.cloud/ulep/auth-prod'
    tag: '1.0.3110'
  env:
    keycloakAdmin: admin
    keycloakAdminPassword: *keycloakAdminPassword
    kcDB: postgres
    kcDBSchema: keycloak
    proxyAddressForwarding: true
    logLevel: warn
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  probes:
    startup:
      initialDelaySeconds: 10
      periodSeconds: 10
      failureThreshold: 12
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 10
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 5
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    hosts:
      - host: *authUrl
        paths: [/]
    tls:
      - hosts:
          - *authUrl

# Full configuration: https://github.com/bitnami/charts/tree/master/bitnami/postgresql
postgresql:  
  primary:
    initdb:
      scriptsConfigMap: ulep-init-database
    persistence:
      size: 8Gi
  global:
    postgresql:
      auth:
        username: 'ulep'
        password: 'AZE123aze'
        database: 'ulep'
    redis:
      password: AZE123aze

mongodb:
  image:
    debug: true
    pullPolicy: Always
  architecture: replicaset
  replicaCount: 1
  persistence:
    size: 8Gi
  auth:
    rootUser: 'root'
    rootPassword: 'AZE123aze'
    usernames: ['ulep']
    passwords: ['AZE123aze']
    databases: ['ulep']
    replicaSetKey: KTGovXollW
  initdbScriptsConfigMap: ulep-mongo-postinstall-configmap

redis:
  pullPolicy: IfNotPresent
  master:
    count: 1
  replica:
    replicaCount: 2
  persistence:
    size: 8Gi
  auth:
    enabled: false
  sentinel:
    masterService:
      enabled: false


minio:
  name: *minioUrl
  global:
    storageClass: scw-bssd
    storageClassName: scw-bssd
  image:
    tag: 2024.5.10-debian-12-r2
    debug: yes
  clientImage:
    tag: 2024.5.10-debian-12-r2
  auth:
    rootUser: *minioAccessKey
    rootPassword: *minioSecretKey
  persistence:
    size: 10Gi
    storageClassName: scw-bssd
    storageClass: scw-bssd
  # Distributed  mode is recommended for PROD
  mode: distributed
  statefulset:
    replicaCount: 2
    drivesPerNode: 2
  ingress:
    enabled: true
    ingressClassName: *ingressName
    hostname: minio.ulep.thestaging.io
    path: /
    pathType: Prefix
    servicePort: 9001
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    extraTls:
      - hosts:
         - minio.ulep.thestaging.io
        secretName: minio-tls
  apiIngress:
    enabled: true
    ingressClassName: *ingressName
    hostname: minio-api.ulep.thestaging.io
    path: /
    pathType: Prefix
    servicePort: 9000
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    extraTls:
      - hosts:
         - minio-api.ulep.thestaging.io
        secretName: minio-api-tls
  #defaultBuckets: "i18n,assets,objective:private,images:private"

admin:
  name: *adminUrl
  replicaCount: 1
  image:
    repository: 'rg.fr-par.scw.cloud/ulep/admin-prod'
    tag: '1.0.3110'
    pullPolicy: IfNotPresent
  env:
    keycloakClientSecret: *keycloakClientSecret
    sentryDsn: https://11fe01856d4343feabbc1fc89bf5e1a8@glitchtip.ulep.thestaging.io/1
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
    # targetMemoryUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  probes:
    startup:
      initialDelaySeconds: 60
      periodSeconds: 30
      failureThreshold: 5
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 3
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 3
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    hosts:
      - host: *adminUrl
        paths: [/]
    tls:
      - hosts:
          - *adminUrl

chat:
  name: *chatUrl
  replicaCount: 2
  image:
    repository: 'rg.fr-par.scw.cloud/ulep/chat-prod'
    tag: '1.0.3110'
    pullPolicy: IfNotPresent
  env:
    mongoInitUser: 'root'
    mongoInitPassword: 'AZE123aze'
    mongoInitDatabase: 'ulep'
    mongoUser: 'ulep'
    mongoPassword: 'AZE123aze'
    mongoDatabase: 'ulep'
    mongoLogLevel: 'debug'
    logLevel: warn
    sentryDsn: https://dcedcfca51fd41c7802454625b604d30@glitchtip.ulep.thestaging.io/2
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
    wsPort: 8080
    appPort: 3000
    appPortWs: 5000
  probes:
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 6
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 5
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    hosts:
      - host: *chatUrl
        paths: [/]

webapp:
  name: *webappUrl
  replicaCount: 1
  image:
    repository: nginx
    tag: '1.25.2-alpine'
    pullPolicy: IfNotPresent
  initImage:
    repository: 'rg.fr-par.scw.cloud/ulep/webapp'
    tag: '1.0.3110'
    pullPolicy: IfNotPresent
  env:
    viteEnv: staging
    viteSentryDsn: https://114df01b27e242e8b59c5aaef9a1673e@glitchtip.ulep.thestaging.io/3
    viteChatUrl: *chatUrl
    viteSocketChatUrl: *socketChatUrl
  pv:
    storage: 4Gi
    storageClassName: scw-bssd
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
    # targetMemoryUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  probes:
    startup:
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 15
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 3
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 3
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    hosts:
      - host: *webappUrl
        paths: [/]
    tls:
      - hosts:
          - *webappUrl

jitsi-meet:
  name: *jitsiUrl
  publicURL: 'https://jitsi.ulep.thestaging.io'
  enableAuth: true
  enableGuests: false
  tz: Europe/Paris

  web:
    ingress:
      enabled: true
      className: *ingressName
      annotations:
        kubernetes.io/ingress.class: *ingressName
        kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
      hosts:
        - host: jitsi.ulep.thestaging.io
          paths: ['/']
      tls:
        - secretName: jitsi-tls
          hosts:
            - jitsi.ulep.thestaging.io
    extraVolumes:
      - name: 'jitsi-meet-swp'
        configMap:
          name: 'jitsi-meet-swp'
          items:
            - key: 'custom-config.js'
              path: 'custom-config.js'
            - key: 'custom-interface_config.js'
              path: 'custom-interface_config.js'
    extraVolumeMounts:
      - name: 'jitsi-meet-swp'
        mountPath: '/config/custom-config.js'
        subPath: 'custom-config.js'
      - name: 'jitsi-meet-swp'
        mountPath: '/config/custom-interface_config.js'
        subPath: 'custom-interface_config.js'

  jvb:
    UDPPort: 30378
    useHostPort: true
    publicIPs:
      - 51.159.157.213
    service:
      enabled: true
      type: LoadBalancer
    securityContext:
      allowPrivilegeEscalation: false
      seccompProfile:
        type: 'RuntimeDefault'
      readOnlyRootFilesystem: false
      runAsNonRoot: false
    xmpp:
      user: 'ulep'
      password: 'AZE123aze'

  prosody:
    persistence:
      enabled: false
    extraEnvs:
      - name: 'AUTH_TYPE'
        value: 'jwt'
      - name: 'JWT_APP_ID'
        value: 'api'
      - name: 'JWT_APP_SECRET'
        value: *keycloakClientSecret
      - name: "TURN_HOST"
        value: "ulep-coturn"
      - name: "TURN_PORT"
        value: "80"
      - name: "TURNS_HOST"
        value: "ulep-coturn"
      - name: "TURNS_PORT"
        value: "443"
      - name: "TURN_TTL"
        value: "86400"
      - name: "TURN_USERNAME"
        value: coturn
      - name: "TURN_PASSWORD"
        value: coturn
      - name: "TURN_CREDENTIALS"
        value: ""
      - name: "TURN_TRANSPORT"
        value: "tcp,udp"
      - name: "JVB_AUTH_USER"
        value: "ulep"
      - name: "JVB_AUTH_PASSWORD"
        value: "AZE123aze"
      - name: "JICOFO_AUTH_USER"
        value: "ulep"
      - name: "JICOFO_AUTH_PASSWORD"
        value: "AZE123aze"
      - name: "JICOFO_COMPONENT_SECRET"
        value: "AZE123aze"
    annotations:
      reloader.stakater.com/match: 'true'
    securityContext:
      allowPrivilegeEscalation: false
      seccompProfile:
        type: 'RuntimeDefault'
      readOnlyRootFilesystem: false
      runAsNonRoot: false
    extraVolumes:
      - name: "jitsi-meet-swp"
        configMap:
          name: "jitsi-meet-swp"
          items:
            - key: "jitsi-meet.cfg.lua"
              path: "jitsi-meet.cfg.lua"
    extraVolumeMounts:
      - name: "jitsi-meet-swp"
        mountPath: "/defaults/conf.d/jitsi-meet.cfg.lua"
        subPath: "jitsi-meet.cfg.lua"

  jicofo:
    xmpp:
      user: 'ulep'
      password: 'AZE123aze'

  jibri:
    enable: false

git:
  name: 'git'
  replicaCount: 1
  image:
    repository: 'rg.fr-par.scw.cloud/ulep/weblate-git-prod'
    tag: 'latest' # REQUIRED
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 2222
  pv:
    storage: 5Gi # 5Gi recommandé
    volumeMode: Filesystem
    storageClassName: scw-bssd   
  resources:
    limits:
      cpu: '3'
      memory: 4000Mi
    requests:
      cpu: '2'
      memory: 3000Mi
  env:
    minioHost: ulep-minio
    minioAccessKey: minio #should be the same as used in project deployment
    minioSecretKey: AZE123aze #should be the same as used in project deployment
    gitPassword: "54321a"
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    hosts:
      - host: weblate-git
        paths: [/] 

weblate:
  name: *weblateApiUrl
  replicaCount: 1
  redis:
    nameOverride: "ulep-redis-weblate"
  postgresql:    
    nameOverride: "ulep-postgres-weblate"
  image:
    repository: 'weblate/weblate'
    tag: '4.18' # REQUIRED
    pullPolicy: IfNotPresent
  env:
    site: weblate
    serverEmail: contact@ulep.fr
    defaultFromEmail: contact@ulep.fr
    emailHost: 'mailcatcher' # REQUIRED
    adminEmail: 'matthieu.chaulet@thetribe.io' # REQUIRED
    adminPassword: 'Pass@word1'
    emailHostUser: 'admin'
    emailHostPassword: 'AZE123aze' # REQUIRED
    emailPort: 1025 # REQUIRED
    allowedHost: '*' # OPTIONNEL
  pv:
    storage: 5Gi # 5Gi recommandé
    volumeMode: Filesystem
    storageClassName: scw-bssd    
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
    # targetMemoryUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  resources:
    limits:
      cpu: '3'
      memory: 4000Mi
    requests:
      cpu: '2'
      memory: 3000Mi
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: letsencrypt
    hosts:
      - host: *weblateApiUrl
        paths: [/]    

glitchtip:
  name: *glitchtipUrl
  redis:
    nameOverride: "ulep-redis-glitchtip"    
    master:
    count: 1
    replica:
      replicaCount: 2
    persistence:
      size: 8Gi    
    sentinel:
      masterService:
        enabled: false
  postgresql:    
    nameOverride: "ulep-postgres-glitchtip"
    fullnameOverride: "ulep-postgres-glitchtip"
    enabled: true
    auth:
      postgresPassword: change_this
    primary:
      persistence:
        size: 10Gi

  image:
    repository: glitchtip/glitchtip
    tag: v3.4.4
    pullPolicy: Always
  env:
    normal:
      GLITCHTIP_DOMAIN: https://glitchtip.ulep.thestaging.io
      EMAIL_URL: smtp://mailcatcher:1025
      DEFAULT_FROM_EMAIL: info@example.com
      ENABLE_USER_REGISTRATION: "True"
    secret:
      SECRET_KEY: "ThisMustBeChanged!" # run openssl rand -hex 32
  web:
    ingress:
      enabled: true
      className: *ingressName
      annotations:
        kubernetes.io/ingress.class: *ingressName        
      hosts:
        - host: *domain
          paths:
            - path: /
              pathType: Prefix      

coturn:
  # --  hostname for the coturn server realm
  realm: "turn.ulep.thestaging.io"
  name: coturn
  externalDatabse:
    enabled: false
  postgresql:
    enabled: false
  auth:
    # -- username for the main user of the turn server; ignored if you existingSecret is not ""
    username: "coturn"
    # -- password for the main user of the turn server; ignored if you existingSecret is not ""
    password: "coturn"
    # -- existing secret with keys username/password for coturn; if this is not "" then we will ignore coturn.auth.username/password
    existingSecret: ""
    secretKeys:
      # -- key in existing secret for turn server user
      username: coturn
      # -- key in existing secret for turn server user's password
      password: coturn



serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ''

imagePullSecrets:
  - name: 'registrypullsecret'

nameOverride: ''
fullnameOverride: ''

podAnnotations: {}

podSecurityContext: {}
# fsGroup: 2000

securityContext: {}
# capabilities:
#   drop:
#   - ALL
# readOnlyRootFilesystem: true
# runAsNonRoot: true
# runAsUser: 1000

resources: {}

nodeSelector: {}

tolerations:
  - key: 'node.kubernetes.io/memory-pressure'
    operator: 'Exists'
    effect: 'NoSchedule'

affinity: {}

reloader:
  reloader:
    deployment:
      resources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 10m
          memory: 128Mi
