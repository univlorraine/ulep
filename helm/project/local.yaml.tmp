# Default values for etandem.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# CLUSTER
name: "ulep"
domain: &domain servogne.com
issuerName: letsencrypt
ingressName: &ingressName nginx

# API
apiUrl: &apiUrl api
firebaseProjectId: &firebaseProjectId ulep-notifications
firebasePrivateKey: &firebasePrivateKey '-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQC0EDoYaG4ioNVx\n1Jk3JPtumkG8sTZxDeWnz93Tt9QTbKQXR1JZFcwUay6cj2sgvVvZvXQEO87suu4M\nY0HN6t55O+AmEVa3Di4jwm5tqXv4Y9jX08iybHM4DXNK2AQeAL37Xyhwx4A+PhKi\n8//HklxPP93a3FglroHWJDOGyKdRsX4sPzjjU3a7cEOhu/r2lidJ5z6i0/WUYc4e\nuRvw7ehG0QjsEle5Xqk1Qk5cHvY9+t1l2xz0I75KQPASCOgWfI5Xdcz7gRA2euCa\n85wLe8D80SzT5aPB7Ig8ljcbt8521GHKBGyxMp6vxj/MZz5FvPPGMynyY34NWhvs\nwmwaFXrpAgMBAAECggEAFKcr0rLftw8VjFnjPQT75eLBmYAGC4+ZgNcBzY/vPk8e\nvyDKHDe40bq9fO2iTv4JM/9b+ERX5qVGOpuD57eBzwwEGLmyZYq11houClv/QS1K\nqO68vWJdENfSGoqOZlaVc+ilPdJULk92WcR82Qo7lkdwDfNqFOBgOgyq8FHBh0gQ\nL/kA/EmPvUUpecxWQqr1JageRh93jk3BSaKgUwIAnLcUwom9Qn8XO/O7KqLeguUP\nmvS++YIC9tNLS9vJ92f/+Ns8+7UWdZzqPgEE5UD7Ba7xvgw1wQPpIHMt/YmXUBab\nrJqW6ADdpfw2p3aZJbamPaxhmVfYRzpyUuAgY3/u9QKBgQDgwJiN4WbQ3FJd+Nv8\nVjYlmfMHbX8F0WPOfIlZbn2R1SeAg/2A1qezanGhg2ukG3RO547TN9t0l4it94E/\n1VRupr/I2t+Ibmpbc7TbxzAjYSsU3oV+tF5h8F2eOtgm26RNMtIojOvKF4g+QDtB\nXP/+ul8UnS+dviJGqpFKj9PFOwKBgQDNGQ7zBr3jUIbvVT1OdDJgrtrqEB4D1Byh\nAyW28WHx4sXrYv1zIIx3nN/k7Kf5oYkYAu9Id31MFm1mD8yge6qUeUKsZpRyePky\nVN8XPKMP+t7z7Wh2EJkCOFJlkMD5qIpfEG1eyZfLM0U8/IxqA672MXB1uJjvBOq+\nxUI33AxuKwKBgFDyjP9s008eSzw1SWYU1uOsEu/16+34gG36RK3FMcy4bMXIxCEH\nLtdb2xlE8BvnF3jjxXklgRD5Eu01W4PWHdbMj/6Tdjb5La1KezU9BIV5lb6qdoIw\nDF5R6CX5I6i7Ku3zA+Y++x2KZDOnhrAAAuOH1H7kLiYuOMIi5LlqG+fJAoGAPxc2\nQgwQ3Zwn5feSpE+aL6OaM+ZBVWwqYl1VfLFEL+RSfdY1oPSiQSlAtmsWQPQv9/Lv\nKJuZL462mG7Dw5pHHuUuXVow0AXmolT5S2ybvI6vhtnBCJCSgNxSfGvK8QGnjxa+\njin1R8y9v8TwbKw1ZgZPUec3JE+e5pBHjmdia4ECgYBu19D0n37HsF6/xdRShQKA\ntm1s/5WXXQvNdN5CXtyWvKWfmVZz6mnm4f3T7pFg1cOHXumol9FQ7/OLbOdMc1QL\nf1fpw4I8O55WotsI9I/G/DCNYlRbI47L/0vEYLE6r9ht4usYo7FCuNGEEzBfyHBc\nm1ri7rtcn3xrDQNDximZVA==\n-----END PRIVATE KEY-----\n'
firebaseClientEmail: &firebaseClientEmail firebase-adminsdk-l8blg@ulep-notifications.iam.gserviceaccount.com

# AUTH
authUrl: &authUrl auth

# JITSI
jitsiUrl: &jitsiUrl jitsi

# ADMIN
adminUrl: &adminUrl admin

# CHAT
chatUrl: &chatUrl chat
socketChatUrl: &socketChatUrl chat-ws

# MINIO
minioApiUrl: &minioApiUrl minio-api
minioUrl: &minioUrl minio
minioAccessKey: &minioAccessKey minio
minioSecretKey: &minioSecretKey AZE123aze

# KEYCLOAK
keycloakUrl: &keycloakUrl auth
keycloakAdminPassword: &keycloakAdminPassword AZE123aze
keycloakClientSecret: &keycloakClientSecret bN49BuApmmtAODeOWOG8iKOOuJdN3KE6

# WEBAPP
webappUrl: &webappUrl webapp

#WEBLATE
weblateApiUrl: &weblateApiUrl weblate

# COTURN
coturnUrl: &coturnUrl coturn

global:
  postgresql:
    auth:
      username: "ulep"
      password: "AZE123aze"
      database: "ulep"
  redis:
    password: AZE123aze

coturn:
  name: coturn
  coturn:
    realm: "coturn.servogne.com"
    extraArgs:
      - "--no-udp" # Désactive UDP
      - "--listening-port=80"
      - "--listening-ip=0.0.0.0"
      - "--allowed-peer-ip=0.0.0.0-255.255.255.255"
      - "--verbose"
      - "--fingerprint"
      - "--lt-cred-mech" # Active l'authentification long-term
      - "--min-port=10000"
      - "--max-port=20000"
    auth:
      username: "coturn"
      password: "coturn"
    portwip:
      listening: 80
  service:
    type: ClusterIP
    port: 80
  ports:
    # Ajoutez les ports TCP explicitement
    - name: turn-tcp
      port: 3478
      targetPort: 3478
      protocol: TCP
    - name: turn-tls
      port: 5349
      targetPort: 5349
      protocol: TCP
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
    hosts:
      - host: *coturnUrl
        paths: [/]

api:
  name: *apiUrl
  replicaCount: 1
  image:
    repository: rg.fr-par.scw.cloud/ulep/api-prod
    tag: "latest"
    pullPolicy: IfNotPresent
  initImage:
    repository: rg.fr-par.scw.cloud/ulep/api-init
    tag: "latest"
    pullPolicy: IfNotPresent
  env:
    adminUrl: *adminUrl
    chatUrl: *chatUrl
    appUrl: *webappUrl
    logLevel: debug
    #logLevel: warn
    defaultTranslationLanguage: en
    keycloakRealm: etandem
    keycloakAdmin: admin
    keycloakClientId: api
    keycloakClientSecret: *keycloakClientSecret
    keycloakAdminRoleName: admin
    minioUrl: https://minio-api.servogne.com
    minioAccessKey: *minioAccessKey
    minioSecretKey: *minioSecretKey
    i18nReloadInterval: "3600000"
    i18nMinioUrl: https://minio-api.servogne.com/i18n
    i18nDebug: true
    emailsAssetsBucket: assets
    notificationAssetsBucket: assets
    emailsTranslationsComponent: emails
    emailsAssetsPublicEndpoint: *minioUrl
    notificationAssetsPublicEndpoint: *minioUrl
    appLinkAppleStore: https://www.apple.com/fr/app-store/etandem
    appLinkPlayStore: https://play.google.com/store/apps/etandem
    smtpDisableBootVerification: false
    smtpHost: mailcatcher
    smtpPort: 1025
    smtpSecure: false
    smtpIgnoreTLS: true
    smtpSender: contact@ulep.fr
    firebaseProjectId: *firebaseProjectId
    firebasePrivateKey: *firebasePrivateKey
    firebaseClientEmail: *firebaseClientEmail
    firebaseParallelLimit: 3
    sentryDsn: https://70f6871957074455870c9f1d0ab2ed24@glitchtip.ulep.thestaging.io/4
    cancelTresholdInMin: 15
    signedUrlExpirationInSeconds: 3600
    weblateApiUrl: *weblateApiUrl
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
    # targetMemoryUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  probes:
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 6
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 5
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
    hosts:
      - host: *apiUrl
        paths: [/]

auth:
  name: *authUrl
  replicaCount: 1
  image:
    repository: "quay.io/keycloak/keycloak"
    tag: "26.0"
    pullPolicy: IfNotPresent
  initImage:
    repository: "rg.fr-par.scw.cloud/ulep/auth-prod"
    tag: "latest"
    pullPolicy: IfNotPresent
  env:
    keycloakAdmin: admin
    keycloakAdminPassword: *keycloakAdminPassword
    kcDB: postgres
    kcDBSchema: keycloak
    proxyAddressForwarding: true
    logLevel: warn
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  probes:
    startup:
      initialDelaySeconds: 10
      periodSeconds: 10
      failureThreshold: 12
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 10
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 5
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
    hosts:
      - host: *authUrl
        paths: [/]

# Full configuration: https://github.com/bitnami/charts/tree/master/bitnami/postgresql
postgresql:
  primary:
    initdb:
      scriptsConfigMap: ulep-init-database
    persistence:
      size: 8Gi

mongodb:
  image:
    debug: true
    pullPolicy: Always
  architecture: replicaset
  replicaCount: 1
  persistence:
    size: 8Gi
  auth:
    rootUser: "root"
    rootPassword: "AZE123aze"
    usernames: ["ulep"]
    passwords: ["AZE123aze"]
    databases: ["ulep"]
  initdbScriptsConfigMap: ulep-mongo-postinstall-configmap

redis:
  pullPolicy: IfNotPresent
  master:
    count: 1
  replica:
    replicaCount: 0
  persistence:
    size: 8Gi
  auth:
    enabled: false

minio:
  name: *minioUrl
  global:
    storageClass: standard
    storageClassName: standard
  image:
    tag: 2025.2.28-debian-12-r0
    debug: yes
  clientImage:
    tag: 2025.2.28-debian-12-r0
  auth:
    rootUser: *minioAccessKey
    rootPassword: *minioSecretKey
  persistence:
    size: 8Gi
    storageClassName: standard
    storageClass: standard
  # Distributed  mode is recommended for PROD
  mode: standalone
  statefulset:
    replicaCount: 1
    drivesPerNode: 2
  # defaultBuckets: 'i18n,assets,objective:private,images:private'
  ingress:
    enabled: true
    ingressClassName: *ingressName
    hostname: minio.servogne.com
    path: /
    pathType: Prefix
    servicePort: 9001
    annotations:
      kubernetes.io/ingress.class: *ingressName
  apiIngress:
    enabled: true
    ingressClassName: *ingressName
    hostname: minio-api.servogne.com
    path: /
    pathType: Prefix
    servicePort: 9000
    annotations:
      kubernetes.io/ingress.class: *ingressName
  defaultBuckets: "i18n,assets,objective:private,images:private"

admin:
  name: *adminUrl
  replicaCount: 1
  image:
    repository: "rg.fr-par.scw.cloud/ulep/admin-prod"
    tag: "latest"
    pullPolicy: IfNotPresent
  env:
    keycloakClientSecret: *keycloakClientSecret
    sentryDsn: https://11fe01856d4343feabbc1fc89bf5e1a8@glitchtip.ulep.thestaging.io/1
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
    # targetMemoryUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  probes:
    startup:
      initialDelaySeconds: 60
      periodSeconds: 30
      failureThreshold: 5
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 3
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 3
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
    hosts:
      - host: *adminUrl
        paths: [/]

chat:
  name: *chatUrl
  replicaCount: 2
  image:
    repository: "rg.fr-par.scw.cloud/ulep/chat-prod"
    tag: "latest"
    pullPolicy: IfNotPresent
  env:
    mongoInitUser: "root"
    mongoInitPassword: "AZE123aze"
    mongoInitDatabase: "ulep"
    mongoUser: "ulep"
    mongoPassword: "AZE123aze"
    mongoDatabase: "ulep"
    mongoLogLevel: "debug"
    logLevel: warn
    sentryDsn: https://dcedcfca51fd41c7802454625b604d30@glitchtip.ulep.thestaging.io/2
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 2
    targetCPUUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
    wsPort: 8080
    appPort: 3000
    appPortWs: 5000
  probes:
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 6
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 5
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
    hosts:
      - host: *chatUrl
        paths: [/]

webapp:
  name: *webappUrl
  replicaCount: 1
  image:
    repository: nginx
    tag: "1.25.2-alpine"
    pullPolicy: IfNotPresent
  initImage:
    repository: "rg.fr-par.scw.cloud/ulep/webapp"
    tag: "latest"
    pullPolicy: IfNotPresent
  env:
    viteEnv: staging
    viteSentryDsn: https://114df01b27e242e8b59c5aaef9a1673e@glitchtip.ulep.thestaging.io/3
    viteChatUrl: *chatUrl
    viteSocketChatUrl: *socketChatUrl
  pv:
    storage: 4Gi
    storageClassName: standard
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
    # targetMemoryUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  probes:
    startup:
      initialDelaySeconds: 30
      periodSeconds: 10
      failureThreshold: 15
    readiness:
      initialDelaySeconds: 0
      periodSeconds: 10
      failureThreshold: 3
    liveness:
      initialDelaySeconds: 0
      periodSeconds: 5
      failureThreshold: 3
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
    hosts:
      - host: *webappUrl
        paths: [/]

jitsi-meet:
  name: *jitsiUrl
  publicURL: "https://jitsi.servogne.com"
  enableAuth: false
  enableGuests: true
  tz: Europe/Paris

  websocket:
    xmpp:
      enabled: true

  web:
    ingress:
      enabled: true
      className: *ingressName
      annotations:
        kubernetes.io/ingress.class: *ingressName
      hosts:
        - host: jitsi.servogne.com
          paths: ["/"]
    extraVolumes:
      - name: "jitsi-meet-swp"
        configMap:
          name: "jitsi-meet-swp"
          items:
            - key: "custom-config.js"
              path: "custom-config.js"
            - key: "custom-interface_config.js"
              path: "custom-interface_config.js"
    extraVolumeMounts:
      - name: "jitsi-meet-swp"
        mountPath: "/config/custom-config.js"
        subPath: "custom-config.js"
      - name: "jitsi-meet-swp"
        mountPath: "/config/custom-interface_config.js"
        subPath: "custom-interface_config.js"

  jvb:
    UDPPort: 30378
    useHostPort: true
    publicIPs:
      - 51.159.157.213
    service:
      enabled: true
      type: LoadBalancer
    securityContext:
      allowPrivilegeEscalation: false
      seccompProfile:
        type: "RuntimeDefault"
      readOnlyRootFilesystem: false
      runAsNonRoot: false
    xmpp:
      user: "ulep"
      password: "AZE123aze"

  prosody:
    persistence:
      enabled: false
    extraEnvs:
      - name: "AUTH_TYPE"
        value: "jwt"
      - name: "JWT_APP_ID"
        value: "api"
      - name: "JWT_APP_SECRET"
        value: *keycloakClientSecret
      - name: "TURN_ENABLE"
        value: "1"
      - name: "TURN_HOST"
        value: "coturn.servogne.com"
      - name: "TURN_PORT"
        value: "80"
      - name: "TURNS_HOST"
        value: "coturn.servogne.com"
      - name: "TURNS_PORT"
        value: "3478"
      - name: "TURN_TTL"
        value: "86400"
      - name: "TURN_USERNAME"
        value: coturn
      - name: "TURN_PASSWORD"
        value: coturn
      - name: "TURN_CREDENTIALS"
        value: ""
      - name: "TURN_TRANSPORT"
        value: "tcp"
      - name: "JVB_AUTH_USER"
        value: "ulep"
      - name: "JVB_AUTH_PASSWORD"
        value: "AZE123aze"
      - name: "JICOFO_AUTH_USER"
        value: "ulep"
      - name: "JICOFO_AUTH_PASSWORD"
        value: "AZE123aze"
      - name: "JICOFO_COMPONENT_SECRET"
        value: "AZE123aze"
    annotations:
      reloader.stakater.com/match: "true"
    securityContext:
      allowPrivilegeEscalation: false
      seccompProfile:
        type: "RuntimeDefault"
      readOnlyRootFilesystem: false
      runAsNonRoot: false
    extraVolumes:
      - name: "jitsi-meet-swp"
        configMap:
          name: "jitsi-meet-swp"
          items:
            - key: "jitsi-meet.cfg.lua"
              path: "jitsi-meet.cfg.lua"
    extraVolumeMounts:
      - name: "jitsi-meet-swp"
        mountPath: "/defaults/conf.d/jitsi-meet.cfg.lua"
        subPath: "jitsi-meet.cfg.lua"

  jicofo:
    xmpp:
      user: "ulep"
      password: "AZE123aze"

  jibri:
    enable: false

git:
  name: "git"
  replicaCount: 1
  image:
    repository: "rg.fr-par.scw.cloud/ulep/weblate-git-prod"
    tag: "latest" # REQUIRED
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 2222
  pv:
    storage: 5Gi # 5Gi recommandé
    volumeMode: Filesystem
    storageClassName: standard
  resources:
    limits:
      cpu: "3"
      memory: 4000Mi
    requests:
      cpu: "2"
      memory: 3000Mi
  env:
    minioHost: ulep-minio
    minioAccessKey: minio #should be the same as used in project deployment
    minioSecretKey: AZE123aze #should be the same as used in project deployment
    gitPassword: "54321a"
  ingress:
    enabled: false
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
    hosts:
      - host: weblate-git
        paths: [/]

weblate:
  name: *weblateApiUrl
  replicaCount: 1
  redis:
    nameOverride: "ulep-redis-weblate"
    fullnameOverride: "ulep-redis-weblate"
  postgresql:
    nameOverride: "ulep-postgres-weblate"
    fullnameOverride: "ulep-postgres-weblate"
  image:
    repository: "weblate/weblate"
    tag: "5.10.2.0" # REQUIRED
    pullPolicy: IfNotPresent
  env:
    site: weblate
    serverEmail: contact@ulep.fr
    defaultFromEmail: contact@ulep.fr
    emailHost: "mailcatcher" # REQUIRED
    adminEmail: "matthieu.chaulet@thetribe.io" # REQUIRED
    adminPassword: "Pass@word1"
    emailHostUser: "admin"
    emailHostPassword: "AZE123aze" # REQUIRED
    emailPort: 1025 # REQUIRED
    allowedHost: "*" # OPTIONNEL
  pv:
    storage: 5Gi # 5Gi recommandé
    volumeMode: Filesystem
    storageClassName: standard
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 100
    targetCPUUtilizationPercentage: 80
    # targetMemoryUtilizationPercentage: 80
  service:
    type: ClusterIP
    port: 80
  resources:
    limits:
      cpu: "3"
      memory: 4000Mi
    requests:
      cpu: "2"
      memory: 3000Mi
  ingress:
    enabled: true
    className: *ingressName
    annotations:
      kubernetes.io/ingress.class: *ingressName
    hosts:
      - host: *weblateApiUrl
        paths: [/]

glitchtip:
  nameOverride: "ulep-glitchtip"
  redis:
    nameOverride: "ulep-redis-glitchtip"
    fullnameOverride: "ulep-redis-glitchtip"
    master:
    count: 1
    replica:
      replicaCount: 2
    persistence:
      size: 8Gi
    sentinel:
      masterService:
        enabled: false
  postgresql:
    nameOverride: "ulep-postgres-glitchtip"
    fullnameOverride: "ulep-postgres-glitchtip"
    enabled: true
    auth:
      postgresPassword: change_this
    primary:
      persistence:
        size: 10Gi
  image:
    repository: glitchtip/glitchtip
    tag: v4.2.5
    pullPolicy: IfNotPresent
  env:
    normal:
      GLITCHTIP_DOMAIN: http://glitchtip.servogne.com
      EMAIL_URL: smtp://mailcatcher:1025
      DEFAULT_FROM_EMAIL: info@example.com
      ENABLE_USER_REGISTRATION: "True"
    secret:
      SECRET_KEY: "ThisMustBeChanged!" # run openssl rand -hex 32
  web:
    ingress:
      enabled: true
      className: *ingressName
      annotations:
        kubernetes.io/ingress.class: *ingressName
      hosts:
        - host: glitchtip.servogne.com
          paths:
            - path: /
              pathType: Prefix

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

imagePullSecrets:
  - name: "registrypullsecret"

nameOverride: ""
fullnameOverride: ""

podAnnotations: {}

podSecurityContext: {}
# fsGroup: 2000

securityContext: {}
# capabilities:
#   drop:
#   - ALL
# readOnlyRootFilesystem: true
# runAsNonRoot: true
# runAsUser: 1000

resources: {}

nodeSelector: {}

tolerations:
  - key: "node.kubernetes.io/memory-pressure"
    operator: "Exists"
    effect: "NoSchedule"

affinity: {}

reloader:
  reloader:
    deployment:
      resources:
        limits:
          cpu: 500m
          memory: 256Mi
        requests:
          cpu: 10m
          memory: 128Mi
