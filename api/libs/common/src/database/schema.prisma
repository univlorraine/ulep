datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  // binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

model Instance {
  id                         String  @id @default(uuid())
  name                       String
  email                      String
  ressource_url              String
  cgu_url                    String
  confidentiality_url        String
  primary_color              String
  primary_background_color   String
  primary_dark_color         String
  secondary_color            String
  secondary_background_color String
  secondary_dark_color       String
  days_before_closure_notification      Int       @default(30)
  is_in_maintenance          Boolean @default(false)
  default_certificate_file_id String? @unique

  DefaultCertificateFile          MediaObjects? @relation(fields: [default_certificate_file_id], references: [id])
}

model CountryCodes {
  id           String          @id @default(uuid())
  name         String
  code         String
  emoji        String
  enable       Boolean         @default(true)
  created_at   DateTime        @default(now())
  updated_at   DateTime        @updatedAt
  Users        Users[]
  Organization Organizations[]

  @@unique([name])
  @@unique([code])
  @@index([code])
  @@map("country_codes")
}

model LanguageCodes {
  id                        String   @id @default(uuid())
  name                      String
  code                      String
  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt
  mainUniversityStatus      String   @default("UNACTIVE")
  secondaryUniversityActive Boolean  @default(false)
  isDiscovery               Boolean  @default(false)

  NativeLanguages        Profiles[]           @relation("NativeLanguage")
  MasteredLanguages      MasteredLanguages[]
  TestedLanguages        TestedLanguages[]
  SuggestedLanguages     SuggestedLanguages[]
  Translations           Translations[]
  TextContents           TextContent[]
  LearningLanguages      LearningLanguages[]  @relation("LearningLanguageLanguage")
  JokerLearningLanguages LearningLanguages[]  @relation("TandemLanguage")
  TandemHistory          TandemHistory[]
  UnmatchedLearningLanguages UnmatchedLearningLanguages[]
  SpecificLanguagesOrganizations          Organizations[]
  NativeLanguageOrganizations          Organizations[]    @relation("NativeLanguageOrganizations")
  OriginalVocabularyList VocabularyList[] @relation("OriginalLanguage")
  TranslationVocabularyList VocabularyList[] @relation("TranslationLanguage")
  Activities             Activity[]
  Events                 Events[] @relation("DiffusionLanguages")

  @@unique([name])
  @@unique([code])
  @@index([code])
  @@map("language_codes")
}

//  * ****************************************************
//  * Universities
//  * ****************************************************
model Organizations {
  id                   String              @id @default(uuid())
  parent_id            String?
  country_code_id      String
  language_code_id     String
  name                 String
  codes                String[]            @default([])
  domains              String[]            @default([])
  image_id             String?             @unique
  default_certificate_file_id String?      @unique
  timezone             String
  admissionStartDate   DateTime
  admissionEndDate     DateTime
  openServiceDate      DateTime            @default(now())
  closeServiceDate     DateTime            @default(now())
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt
  website              String?
  pairing_mode         String              @default("MANUAL")
  max_tandems_per_user Int                 @default(1)
  notification_email   String?
  default_contact_id   String?             @unique
  Parent               Organizations?      @relation("Organizations", fields: [parent_id], references: [id], onDelete: Cascade)
  Childrens            Organizations[]     @relation("Organizations")
  Country              CountryCodes        @relation(fields: [country_code_id], references: [id])
  Users                Users[]
  Places               Places[]
  RoutineExecutions    RoutineExecutions[]
  ValidatedTandems     Tandems[]
  RefusedTandems       RefusedTandems[]
  SpecificLanguagesAvailable   LanguageCodes[]
  NativeLanguage              LanguageCodes     @relation("NativeLanguageOrganizations", fields: [language_code_id], references: [id])
  Image                 MediaObjects? @relation("UniversitiesImage", fields: [image_id], references: [id])
  Contact               Contacts?      @relation(fields: [default_contact_id], references: [id])
  DefaultCertificateFile MediaObjects? @relation("UniversitiesDefaultCertificateFile", fields: [default_certificate_file_id], references: [id])
  Activities            Activity[]
  News                  News[]
  EventsConcernedUniversities   Events[] @relation("ConcernedUniversities")
  EventsAuthorUniversity  Events[] @relation("AuthorUniversity")

  @@unique([name])
  @@map("organizations")
}

model Places {
  id                String              @id @default(uuid())
  name              String
  organization_id   String
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  Organization      Organizations       @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  LearningLanguages LearningLanguages[]

  @@unique([name])
  @@map("places")
}

model SuggestedLanguages {
  id               String        @id @default(uuid())
  language_code_id String
  user_id          String
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  LanguageCode     LanguageCodes @relation(fields: [language_code_id], references: [id], onDelete: Cascade)
  User             Users         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([language_code_id, user_id])
  @@map("suggested_languages")
}

model Contacts {
  id                String          @id
  organization_id   String?
  User              Users[]
  Organizations     Organizations?

  @@map("contacts")
}

//  * ****************************************************
//  * Users
//  * ****************************************************
model Users {
  id                 String               @id @default(uuid())
  provider           String               @default("email")
  organization_id    String
  email              String
  firstname          String
  lastname           String
  age                Int
  contact_id         String?
  gender             String
  role               String
  status             String?              @default("ACTIVE")
  deactivated        Boolean              @default(false)
  deactivated_reason String?
  accepts_email      Boolean              @default(true)
  division           String?
  diploma            String?
  staff_function     String?
  country_code_id    String?
  image_id           String?              @unique
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt
  Organization       Organizations        @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  Nationality        CountryCodes?        @relation(fields: [country_code_id], references: [id], onDelete: SetNull)
  Avatar             MediaObjects?        @relation(fields: [image_id], references: [id])
  Reports            Reports[]
  Profiles           Profiles?
  SuggestedLanguages SuggestedLanguages[]
  Devices            Device[]
  Contact            Contacts?            @relation(fields: [contact_id], references: [id])

  @@unique([email])
  @@map("users")
}

model Device {
    token        String          @id
    is_android   Boolean         @default(false)
    is_ios       Boolean         @default(false)
    user_id      String
    created_at   DateTime        @default(now())
    updated_at   DateTime        @updatedAt
    User         Users           @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

//  * ****************************************************
//  * Media Objects
//  * ****************************************************
model MediaObjects {
  id         String              @id @default(uuid())
  name       String
  bucket     String
  mime       String
  size       Int
  created_at DateTime            @default(now())
  updated_at DateTime            @updatedAt
  User       Users?
  Goal       LearningObjectives?
  University Organizations? @relation("UniversitiesImage")
  PronunciationWord Vocabulary? @relation("PronunciationWord")
  PronunciationTranslation Vocabulary? @relation("PronunciationTranslation")
  Activity   Activity? @relation("Image")
  ActivityRessourceFile Activity? @relation("RessourceFile")
  ActivityVocabulary ActivityVocabulary?
  InstanceDefaultCertificateFile Instance?
  UniversitiesDefaultCertificateFile Organizations? @relation("UniversitiesDefaultCertificateFile")
  News       News?
  LearningLanguageCertificateFile LearningLanguages? @relation("LearningLanguageCertificateFile")
  Event      Events?

  @@unique([name, bucket])
  @@map("media_objects")
}

//  * ****************************************************
//  * Translations
//  * ****************************************************
model TextContent {
  id                   String                @id @default(uuid())
  text                 String
  language_id          String
  created_at           DateTime              @default(now())
  updated_at           DateTime              @updatedAt
  LanguageCode         LanguageCodes         @relation(fields: [language_id], references: [id], onDelete: Cascade)
  ProficiencyQuestions ProficiencyQuestions?
  ReportCategories     ReportCategories?
  InterestCategories   InterestCategories?
  Interests            Interests?
  Goals                LearningObjectives?
  Translations         Translations[]
  NewsTitle            News[] @relation("NewsTitleTextContent")
  NewsContent          News[] @relation("NewsContentTextContent")
  EventTitle           Events[] @relation("EventTitleTextContent")
  EventContent         Events[] @relation("EventContentTextContent")
  ActivityThemes       ActivityThemes?
  ActivityThemesCategories ActivityThemeCategories?

  @@map("text_content")
}

model Translations {
  text_content_id String
  language_id     String
  text            String
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  LanguageCode    LanguageCodes @relation(fields: [language_id], references: [id])
  TextContent     TextContent   @relation(fields: [text_content_id], references: [id], onDelete: Cascade)

  @@unique([text_content_id, language_id])
  @@index([text_content_id])
  @@index([language_id])
  @@map("translations")
}

//  * ****************************************************
//  * Proficiency
//  * ****************************************************
model ProficiencyTests {
  id         String                 @id @default(uuid())
  level      String
  created_at DateTime               @default(now())
  updated_at DateTime               @updatedAt
  Questions  ProficiencyQuestions[]

  @@unique([level])
  @@map("proficiency_tests")
}

model ProficiencyQuestions {
  id              String           @id @default(uuid())
  test_id         String
  text_content_id String
  answer          Boolean          @default(true)
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt
  ProficiencyTest ProficiencyTests @relation(fields: [test_id], references: [id], onDelete: Cascade)
  TextContent     TextContent      @relation(fields: [text_content_id], references: [id], onDelete: Cascade)

  @@unique([text_content_id])
  @@map("proficiency_questions")
}

//  * ****************************************************
//  * Reports
//  * ****************************************************
model Reports {
  id         String           @id @default(uuid())
  content    String
  categoryId String
  status     String           @default("OPEN")
  comment    String?
  userId     String?
  metadata   Json?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  Category   ReportCategories @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  User       Users?           @relation(fields: [userId], references: [id])

  @@index([categoryId], name: "category_id")
  @@index([userId], name: "user_id")
  @@map("reports")
}

model ReportCategories {
  id              String      @id @default(uuid())
  text_content_id String
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  TextContent     TextContent @relation(fields: [text_content_id], references: [id], onDelete: Cascade)
  Reports         Reports[]

  @@unique([text_content_id])
  @@map("report_categories")
}

//  * ****************************************************
//  * Profiles
//  * ****************************************************
model Profiles {
  id                          String   @id @default(uuid())
  user_id                     String
  native_language_code_id     String
  meeting_frequency           String
  bio                         Json
  availabilities              Json?
  availabilities_note         String?
  availabilities_note_privacy Boolean?
  created_at                  DateTime @default(now())
  updated_at                  DateTime @updatedAt

  User              Users                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  NativeLanguage    LanguageCodes        @relation("NativeLanguage", fields: [native_language_code_id], references: [id])
  LearningLanguages LearningLanguages[]
  MasteredLanguages MasteredLanguages[]
  TestedLanguages   TestedLanguages[]
  Goals             LearningObjectives[]
  Interests         Interests[]
  CreatorVocabularyList    VocabularyList[] @relation("Creator")
  EditorVocabularyList    VocabularyList[]  @relation("Editor")
  Activities        Activity[]
  Events            Events[]

  @@unique([user_id])
  @@index([native_language_code_id], name: "native_language_code")
  @@map("profiles")
}

// Many to many relation between Profiles and LanguageCodes
model MasteredLanguages {
  profile_id       String
  language_code_id String
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  Profile          Profiles      @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  LanguageCode     LanguageCodes @relation(fields: [language_code_id], references: [id])

  @@id([profile_id, language_code_id])
  @@map("mastered_languages")
}

model TestedLanguages {
  profile_id       String
  language_code_id String
  created_at       DateTime      @default(now())
  updated_at       DateTime      @updatedAt
  level            String
  Profile          Profiles      @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  LanguageCode     LanguageCodes @relation(fields: [language_code_id], references: [id])

  @@id([profile_id, language_code_id])
  @@map("tested_languages")
}

model LearningObjectives {
  id              String        @id @default(uuid())
  text_content_id String
  image_id        String?       @unique
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  TextContent     TextContent   @relation(fields: [text_content_id], references: [id], onDelete: Cascade)
  Image           MediaObjects? @relation(fields: [image_id], references: [id])
  Profiles        Profiles[]

  @@unique([text_content_id])
  @@map("goals")
}

model LearningLanguages {
  id                      String   @id @default(uuid())
  profile_id              String
  language_code_id        String
  level                   String
  learning_type           String
  same_gender             Boolean
  same_age                Boolean
  same_tandem_email       String?
  certificate_option      Boolean?
  specific_program        Boolean?
  has_priority            Boolean?
  learning_journal        Boolean?
  consulting_interview    Boolean?
  shared_certificate      Boolean?
  certificate_file_id     String? @unique
  campus_id               String?
  tandem_id               String?
  tandem_language_code_id String?
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  Profile        Profiles         @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  Tandem         Tandems?         @relation(fields: [tandem_id], references: [id])
  TandemLanguage LanguageCodes?   @relation("TandemLanguage", fields: [tandem_language_code_id], references: [id])
  LanguageCode   LanguageCodes    @relation("LearningLanguageLanguage", fields: [language_code_id], references: [id])
  RefusedTandems RefusedTandems[]
  Campus         Places?          @relation(fields: [campus_id], references: [id])
  CertificateFile MediaObjects?   @relation("LearningLanguageCertificateFile", fields: [certificate_file_id], references: [id])

  @@map("learning_languages")
}

//  * ****************************************************
//  * Interests
//  * ****************************************************
model Interests {
  id              String             @id @default(uuid())
  category_id     String
  text_content_id String
  created_at      DateTime           @default(now())
  updated_at      DateTime           @updatedAt
  Category        InterestCategories @relation(fields: [category_id], references: [id], onDelete: Cascade)
  TextContent     TextContent        @relation(fields: [text_content_id], references: [id], onDelete: Cascade)
  Profiles        Profiles[]

  @@unique([text_content_id])
  @@map("interests")
}

model InterestCategories {
  id              String      @id @default(uuid())
  text_content_id String
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  TextContent     TextContent @relation(fields: [text_content_id], references: [id], onDelete: Cascade)
  Interests       Interests[]

  @@unique([text_content_id])
  @@map("interests_categories")
}

//  * ****************************************************
//  * Tandems
//  * ****************************************************
model Tandems {
  id                    String              @id @default(uuid())
  status                String              @default("ACTIVE")
  // We store compatibilityScore as an Int in order to avoid float approximation
  // This means the score between 0-1 (float) should be converted to 0-100 (int)
  compatibilityScore    Int                 @default(0)
  learning_type         String              
  created_at            DateTime            @default(now())
  updated_at            DateTime            @updatedAt
  LearningLanguages     LearningLanguages[]
  UniversityValidations Organizations[]
  Sessions Sessions[]

  @@index([status], name: "status")
  @@map("tandems")
}

model RoutineExecutions {
  id           String          @id @default(uuid())
  sponsor_id   String
  status       String
  Universities Organizations[]
  created_at   DateTime        @default(now())
  updated_at   DateTime        @updatedAt
}

model RefusedTandems {
  id                String              @id @default(uuid())
  LearningLanguages LearningLanguages[]
  University        Organizations       @relation(fields: [organizationsId], references: [id])
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  organizationsId   String
}

//  * ****************************************************
//  * Purges
//  * ****************************************************
model Purges {
  id            String          @id @default(uuid())
  author_id     String
  created_at    DateTime        @default(now())
  TandemHistory TandemHistory[]
  UnmatchedLearningLanguages UnmatchedLearningLanguages[]

  @@map("purges")
}

model Blacklist {
  id         String   @id @default(uuid())
  user_id    String   @unique
  email      String?
  created_at DateTime @default(now())

  @@map("blacklist")
}

model TandemHistory {
  id               String        @id @default(uuid())
  user_id          String
  user_email       String
  purge_id         String
  tandem_id        String
  language_code_id String
  created_at       DateTime      @default(now())
  Purge            Purges        @relation(fields: [purge_id], references: [id], onDelete: Cascade)
  Language         LanguageCodes @relation(fields: [language_code_id], references: [id])

  @@unique([user_id, tandem_id])
  @@map("tandem_history")
}

model UnmatchedLearningLanguages {
  id               String        @id @default(uuid())
  user_id          String
  purge_id         String
  language_code_id String
  created_at       DateTime      @default(now())
  Purge            Purges        @relation(fields: [purge_id], references: [id], onDelete: Cascade)
  Language         LanguageCodes @relation(fields: [language_code_id], references: [id])

  @@unique([user_id, language_code_id])
  @@map("unmatched_learning_languages")
}
//  * ****************************************************
//  * Vocabulary
//  * ****************************************************
model VocabularyList {
  id                  String        @id @default(uuid())
  name                String
  symbol              String
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt
  creator_id          String?
  original_language_code_id String
  translation_language_code_id String

  OriginalLanguage    LanguageCodes         @relation("OriginalLanguage", fields: [original_language_code_id], references: [id], onDelete: Cascade)
  TranslationLanguage    LanguageCodes      @relation("TranslationLanguage", fields: [translation_language_code_id], references: [id], onDelete: Cascade)
  Creator               Profiles?            @relation("Creator", fields: [creator_id], references: [id])
  Editors               Profiles[]          @relation("Editor")
  Vocabulary          Vocabulary[]

  @@map("vocabulary_list")
}

model  Vocabulary {
  id                String        @id @default(uuid())
  word              String
  translation       String
  vocabulary_list_id String
  pronunciation_word_id   String? @unique
  pronunciation_translation_id   String? @unique

  VocabularyList VocabularyList @relation(fields: [vocabulary_list_id], references: [id], onDelete: Cascade)
  PronunciationWord MediaObjects? @relation("PronunciationWord", fields: [pronunciation_word_id], references: [id])
  PronunciationTranslation MediaObjects? @relation("PronunciationTranslation", fields: [pronunciation_translation_id], references: [id])

    @@map("vocabulary")
}



//  * ****************************************************
//  * ACTIVITY
//  * ****************************************************
model Activity {
  id                String        @id @default(uuid())
  title             String
  description       String
  university_id     String
  creator_id        String?
  status            String       @default("DRAFT")
  credit_image      String?
  image_id          String?       @unique
  language_level    String
  language_code_id  String
  activity_theme_id String
  ressource_url     String?
  ressource_file_id String?       @unique
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  metadata          Json?

  Image MediaObjects? @relation("Image", fields: [image_id], references: [id])
  RessourceFile MediaObjects? @relation("RessourceFile", fields: [ressource_file_id], references: [id])
  LanguageCode LanguageCodes @relation(fields: [language_code_id], references: [id])
  Creator Profiles? @relation(fields: [creator_id], references: [id])
  University Organizations @relation(fields: [university_id], references: [id])
  ActivityVocabulary ActivityVocabulary[]
  ActivityExercises ActivityExercises[]
  ActivityThemes ActivityThemes @relation(fields: [activity_theme_id], references: [id], onDelete: Cascade)

  @@map("activity")
}

model ActivityThemes {
  id              String             @id @default(uuid())
  category_id     String
  text_content_id String
  created_at      DateTime           @default(now())
  updated_at      DateTime           @updatedAt
  TextContent     TextContent        @relation(fields: [text_content_id], references: [id], onDelete: Cascade)
  Category        ActivityThemeCategories @relation(fields: [category_id], references: [id], onDelete: Cascade)
  Activity Activity[]

  @@unique([text_content_id])
  @@map("activity_themes")
}

model ActivityThemeCategories {
  id              String      @id @default(uuid())
  text_content_id String
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt
  TextContent     TextContent @relation(fields: [text_content_id], references: [id], onDelete: Cascade)
  ActivityThemes       ActivityThemes[]

  @@unique([text_content_id])
  @@map("activity_themes_categories")
}

model ActivityVocabulary {
  id                String        @id @default(uuid())
  content           String
  activity_id       String
  pronunciation_activity_vocabulary_id String? @unique
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  PronunciationActivityVocabulary MediaObjects? @relation(fields: [pronunciation_activity_vocabulary_id], references: [id])
  Activity Activity @relation(fields: [activity_id], references: [id])

  @@map("activity_vocabulary")
}

model ActivityExercises {
  id                String        @id @default(uuid())
  content           String
  order             Int
  activity_id       String
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt

  Activity Activity @relation(fields: [activity_id], references: [id])

  @@map("activity_exercises")
}


//  * ****************************************************
//  * News
//  * ****************************************************

model News {
  id                      String   @id @default(uuid())
  title_text_content_id   String
  content_text_content_id String
  university_id           String
  image_id                String? @unique
  status                  String  @default("DRAFT")
  start_publication_date  DateTime
  end_publication_date    DateTime
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt
  Organization            Organizations @relation(fields: [university_id], references: [id], onDelete: Cascade)
  Image                   MediaObjects? @relation(fields: [image_id], references: [id])
  TitleTextContent        TextContent   @relation("NewsTitleTextContent", fields: [title_text_content_id], references: [id], onDelete: Cascade)
  ContentTextContent      TextContent   @relation("NewsContentTextContent", fields: [content_text_content_id], references: [id], onDelete: Cascade)
}

//  * ****************************************************
//  * Sessions
//  * ****************************************************

model Sessions {
  id           String    @id @default(uuid())
  tandem_id    String
  start_at     DateTime
  comment      String?
  cancelled_at DateTime?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  Tandem       Tandems   @relation(fields: [tandem_id], references: [id], onDelete: Cascade)

  @@map("sessions")
}

//  * ****************************************************
//  * EVENTS
//  * ****************************************************

model Events {
  id                      String   @id @default(uuid())
  title_text_content_id   String
  content_text_content_id String
  university_id           String
  image_id                String? @unique
  image_credit            String?
  status                  String  @default("DRAFT")
  start_date              DateTime
  end_date                DateTime
  type                    String
  event_url               String?
  address                 String?
  address_name            String?
  deep_link               String?
  with_subscription       Boolean @default(false)
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt
  
  SubscribedProfiles      Profiles[]
  DiffusionLanguages      LanguageCodes[] @relation("DiffusionLanguages")
  ConcernedUniversities   Organizations[] @relation("ConcernedUniversities")
  AuthorUniversity        Organizations @relation("AuthorUniversity", fields: [university_id], references: [id], onDelete: Cascade)
  Image                   MediaObjects? @relation(fields: [image_id], references: [id])
  TitleTextContent        TextContent   @relation("EventTitleTextContent", fields: [title_text_content_id], references: [id], onDelete: Cascade)
  ContentTextContent      TextContent   @relation("EventContentTextContent", fields: [content_text_content_id], references: [id], onDelete: Cascade)

  @@map("events")
}
