datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

model User {
  id                    String              @id
  email                 String              @unique
  firstname             String?
  lastname              String?
  avatar                MediaObject?        @relation(fields: [avatarId], references: [id], onDelete: Cascade)
  avatarId              String?             @unique
  profile               Profile?
  reports               Report[]
  requests              LanguageRequest[]

  @@map("users")
}

model Language {
  code                    String               @id
  name                    String
  UniversityLanguages     UniversityLanguage[]
  nativeSpeakers          Profile[]            @relation("NativeLanguage")
  learningUsers           Profile[]            @relation("LearningLanguage")
  masteredByUsers         MasteredLanguage[]
  requests                LanguageRequest[]

  @@map("languages")
}

model LanguageRequest {
  id                     String               @id @default(uuid())
  createdAt              DateTime             @default(now())
  languageCode           String
  language               Language             @relation(fields: [languageCode], references: [code], onDelete: Cascade)
  userId                 String
  user                   User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("language_requests")
  @@unique([languageCode, userId])
}

model University {
  id                    String              @id @default(uuid())
  name                  String              @unique
  timezone              String
  admissionStart        DateTime
  admissionEnd          DateTime
  website               String?
  resourcesUrl          String?
  createdAt             DateTime            @default(now())
  parent                University?         @relation("partners", fields: [parentId], references: [id], onDelete: Cascade)
  parentId              String?
  children              University[]        @relation("partners")
  campuses              Campus[]
  languages             UniversityLanguage[]
  profiles              Profile[]

  @@map("universities")
}

model Campus {
  id                    String              @id @default(uuid())
  name                  String
  universityId          String
  university            University          @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

model UniversityLanguage {
  university            University          @relation(fields: [universityId], references: [id], onDelete: Cascade)
  universityId          String
  language              Language            @relation(fields: [languageCode], references: [code], onDelete: Cascade)
  languageCode          String

  @@id([universityId, languageCode])
  @@map("universities_languages")
}

model Profile {
  id                    String              @id @default(uuid())
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String              @unique
  age                   Int
  gender                String
  role                  String
  metadata              Json // department, diploma, bio, etc.
  university            University          @relation(fields: [universityId], references: [id], onDelete: Cascade)
  universityId          String
  nativeLanguage        Language            @relation("NativeLanguage", fields: [nativeLanguageCode], references: [code])
  nativeLanguageCode    String
  learningLanguage      Language?           @relation("LearningLanguage", fields: [learningLanguageCode], references: [code])
  learningLanguageCode  String?
  learningLanguageLevel String
  masteredLanguages     MasteredLanguage[]
  preferences           LearningPreference  @relation(fields: [preferencesId], references: [id], onDelete: Cascade)
  preferencesId         String              @unique
  tandems               ProfilesOnTandems[]
  createdAt             DateTime            @default(now())

  @@index([nativeLanguageCode], name: "native_language_code")
  @@index([learningLanguageCode], name: "learning_language_code")
  @@index([universityId], name: "university_id")
  @@map("profiles")
}

// Many to many relation between Profile and Language
model MasteredLanguage {
  profileId             String
  languageCode          String
  profile               Profile             @relation(fields: [profileId], references: [id])
  language              Language            @relation(fields: [languageCode], references: [code])

  @@id([profileId, languageCode])
  @@map("mastered_languages")
}

model LearningPreference {
  id                    String              @id @default(uuid())
  profile               Profile?
  type                  String
  sameGender            Boolean

  @@map("learning_preferences")
}

model Tandem {
  id                    String              @id @default(uuid())
  status                String              @default("active") // Either active or inactive
  profiles              ProfilesOnTandems[]

  @@index([status], name: "status")
  @@map("tandems")
}

model ProfilesOnTandems {
  profile               Profile            @relation(fields: [profileId], references: [id], onDelete: Cascade)
  profileId             String
  tandem                Tandem             @relation(fields: [tandemId], references: [id], onDelete: Cascade)
  tandemId              String

  @@id([profileId, tandemId])
  @@map("profiles_on_tandems")
}

model MediaObject {
  id                    String              @id @default(uuid())
  name                  String
  bucket                String
  mime                  String
  size                  Int
  createdAt             DateTime            @default(now())
  user                  User?

  @@map("media_objects")
}

model Report {
  id                    String              @id @default(uuid())
  content               String
  categoryId            String
  userId                String
  category              ReportCategory      @relation(fields: [categoryId], references: [id])
  user                  User                @relation(fields: [userId], references: [id])
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@map("reports")
}

model ReportCategory {
  id                    String              @id @default(uuid())
  name                  String              @unique
  reports               Report[]            // Category to Reports relation, one category can have many reports

  @@map("report_categories")
}

model Country {
  code                  String              @id
  name                  String
  createdAt             DateTime            @default(now())

  @@map("countries")
}

model CEFRTest {
  id                    String              @id @default(uuid())
  level                 String              @unique
  questions             CEFRQuestion[]

  @@map("cefr_tests")
  @@index([level], name: "level")
}

model CEFRQuestion {
  id                    String              @id @default(uuid())
  value                 String
  answer                Boolean
  test                  CEFRTest            @relation(fields: [testId], references: [id], onDelete: Cascade)
  testId                String

  @@map("cefr_questions")
}